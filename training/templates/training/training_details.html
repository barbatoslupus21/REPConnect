{% extends "main.html" %}
{% load static %}
{% csrf_token %}

{% block title %}REPConnect - Training Evaluation{% endblock title %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/training/training.css' %}">
{% endblock %}

{% block content %}

<div class="page-content">
        <div class="page-header">
            <div class="page-header-content">
                <h2 class="page-title">{{ training.title }}</h2>
                <p class="page-subtitle">{{ training.objective }}</p>
                
                <div class="training-meta-grid">
                        <div class="meta-item">
                            <i class="fas fa-user"></i>
                            <span>{{ training.speaker }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>{{ training.training_date|date:"F d, Y" }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-users"></i>
                            <span>{{ total_participants }} Participants</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-percentage"></i>
                            <span>{{ progress_percentage }}% Complete</span>
                        </div>
                </div>

            </div>
            <div class="page-actions">
                <a href="{% url 'admin_training_evaluation' %}" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i>
                    Back to Admin
                </a>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="dashboard-stats">
            <div class="modern-stats-grid">
                <div class="modern-stat-card">
                    <div class="modern-stat-icon blue">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="modern-stat-label">Total Participants</div>
                    <div class="modern-stat-value">{{ total_participants }}</div>
                    <div class="modern-stat-change {% if participants_change >= 0 %}positive{% else %}negative{% endif %}">
                        <span class="modern-stat-change-icon">
                            <i class="fas {% if participants_change >= 0 %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
                        </span>
                            {{ participants_change|floatformat:1 }}%
                        <span class="modern-stat-change-text">vs prev. month</span>
                    </div>
                </div>
                <div class="modern-stat-card">
                    <div class="modern-stat-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="modern-stat-label">Submitted</div>
                    <div class="modern-stat-value">{{ submitted_count }}</div>
                    <div class="modern-stat-change {% if submitted_change >= 0 %}positive{% else %}negative{% endif %}">
                        <span class="modern-stat-change-icon">
                            <i class="fas {% if submitted_change >= 0 %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
                        </span>
                            {{ submitted_change|floatformat:1 }}%
                        <span class="modern-stat-change-text">vs prev. month</span>
                    </div>
                </div>
                <div class="modern-stat-card">
                    <div class="modern-stat-icon orange">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="modern-stat-label">In Progress</div>
                    <div class="modern-stat-value">{{ in_progress_count }}</div>
                    <div class="modern-stat-change {% if in_progress_change >= 0 %}positive{% else %}negative{% endif %}">
                        <span class="modern-stat-change-icon">
                            <i class="fas {% if in_progress_change >= 0 %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
                        </span>
                            {{ in_progress_change|floatformat:1 }}%
                        <span class="modern-stat-change-text">vs prev. month</span>
                    </div>
                </div>
                <div class="modern-stat-card">
                    <div class="modern-stat-icon red">
                        <i class="fas fa-minus-circle"></i>
                    </div>
                    <div class="modern-stat-label">Not Started</div>
                    <div class="modern-stat-value">{{ not_started_count }}</div>
                    <div class="modern-stat-change {% if not_started_change >= 0 %}positive{% else %}negative{% endif %}">
                        <span class="modern-stat-change-icon">
                            <i class="fas {% if not_started_change >= 0 %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
                        </span>
                            {{ not_started_change|floatformat:1 }}%
                        <span class="modern-stat-change-text">vs prev. month</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Participants Table -->
        <div class="table-actions table-actions-bar">
            <div class="table-actions-left" data-intro="Search for employees by name, ID number, or email" data-step="8">
                <div class="search-box">
                    <input type="text" class="search-input" id="trainingSearchInput" placeholder="Search participants..." name="search" value="{{ search }}" />
                    <span class="search-icon"><i class="fas fa-search"></i></span>
                    <span class="search-clear" style="display: {% if search %}block{% else %}none{% endif %};">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            </div>
            <div class="table-actions-right" style="position:relative;">
                <button class="btn btn-action" onclick="exportTrainingReport()">
                    <i class="fas fa-download"></i>
                    Export Report
                </button>
            </div>                                
        </div>

        <div class="common-table-container">
                <table class="data-table" id="participantsTable">
                    <thead>
                        <tr>
                            <th>Id Number</th>
                            <th>Employee Name</th>
                            <th class="hide-column">Department</th>
                            <th class="hide-column">Position</th>
                            <th style="text-align:center;">Status</th>
                            <th class="hide-column">Submitted Date</th>
                            <th style="text-align:center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for participant in participants_data %}
                        <tr class="participant-row" data-status="{% if participant.is_submitted %}submitted{% else %}pending{% endif %}"
                            data-name="{{ participant.name|lower }}"
                            data-username="{{ participant.username|lower }}"
                            data-department="{{ participant.department|lower }}"
                            data-position="{{ participant.position|lower }}">
                            <td>{{ participant.idnumber }}</td>
                            <td>{{ participant.name }}</td>
                            <td class="hide-column">{{ participant.department }}</td>
                            <td class="hide-column">{{ participant.position }}</td>
                            <td style="text-align:center;">
                                <span class="status-pill 
                                    {% if participant.status == 'Submitted' %}status-yellow
                                    {% elif participant.status == 'Supervisor Reviewed' %}status-blue
                                    {% elif participant.status == 'Manager Reviewed' %}status-purple
                                    {% elif participant.status == 'Approved' %}status-green
                                    {% elif participant.status == 'Disapproved' %}status-red
                                    {% elif participant.status == 'Not Started' %}status-gray
                                    {% else %}status-orange{% endif %}">
                                    {{ participant.status }}
                                </span>
                            </td>
                            <td class="hide-column">
                                {% if participant.submitted_at %}
                                    {{ participant.submitted_at|date:"M d, Y" }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td style="text-align:center;">
                                {% if participant.is_submitted and participant.evaluation_id %}
                                    <button class="btn btn-icon view-evaluation-btn" data-evaluation-id="{{ participant.evaluation_id }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">
                                {% if search %}
                                    <div class="empty-state">
                                        <i class="fa fa-search"></i>
                                        <h5>No Results Found</h5>
                                        <p>No participants found matching "{{ search }}". Try adjusting your search terms.</p>
                                    </div>
                                {% else %}
                                    <div class="empty-state">
                                        <i class="fa fa-users"></i>
                                        <h5>No Participants</h5>
                                        <p>No participants assigned to this training</p>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
        </div>

        <div class="pagination" id="paginationContainer">
            <div class="pagination-info">
                Showing <span id="startRecord">{{ page_obj.start_index }}</span> to <span id="endRecord">{{ page_obj.end_index }}</span> of <span id="totalRecords">{{ page_obj.paginator.count }}</span> entries
            </div>
            <div class="pagination-controls" id="paginationControls">
                {% if page_obj.has_previous %}
                    <a class="pagination-btn ajax-page-btn" data-page="{{ page_obj.previous_page_number }}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                {% else %}
                    <span class="pagination-btn" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </span>
                {% endif %}
                <div id="pageNumbers">
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <span class="pagination-btn active">{{ num }}</span>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <a class="pagination-btn ajax-page-btn" data-page="{{ num }}">{{ num }}</a>
                        {% endif %}
                    {% endfor %}
                </div>
                {% if page_obj.has_next %}
                    <a class="pagination-btn ajax-page-btn" data-page="{{ page_obj.next_page_number }}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                {% else %}
                    <span class="pagination-btn" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </span>
                {% endif %}
            </div>
        </div>
    </div>

<!-- Off-canvas for Evaluation Details -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="evaluationDetailsOffcanvas" aria-labelledby="evaluationDetailsOffcanvasLabel">
    <div class="offcanvas-header">
        <h4 class="offcanvas-title" id="evaluationDetailsOffcanvasLabel">Training Evaluation Details</h4>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close">
            <i class="fa fa-times"></i>
        </button>
    </div>
    <div class="offcanvas-body" id="evaluationDetailsContent">
        <!-- Content will be loaded here via AJAX -->
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const statusData = {{ status_counts|safe }};
    const departmentData = {{ department_counts|safe }};
    const progressData = {{ progress_data|safe }};
    const trainingId = {{ training.id }};
    window.trainingId = trainingId; // Make it globally accessible
</script>
<script src="{% static 'js/training/training_details.js' %}"></script>
{% endblock extra_js %}
