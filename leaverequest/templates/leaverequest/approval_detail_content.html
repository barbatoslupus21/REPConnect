{% load static %}
<link rel="stylesheet" href="{% static 'css/leave/leave.css' %}">

<div class="leave-detail-content">
    <!-- Leave Details Section -->
    <div class="detail-section">
        <div class="detail-header">
            <h4>Leave Request Information</h4>
        </div>
        <div class="employee-info-grid">
            <div>
                <div class="info-label">Control Number:</div>
                <div class="info-value">{{ leave_request.control_number }}</div>
            </div>
            <div>
                <div class="info-label">Date Prepared:</div>
                <div class="info-value">{{ leave_request.date_prepared|date:"M d, Y" }}</div>
            </div>
            <div>
                <div class="info-label">Requested By:</div>
                <div class="info-value">{{ leave_request.employee.firstname }} {{ leave_request.employee.lastname }}</div>
            </div>
            <div>
                <div class="info-label">Department/Line:</div>
                <div class="info-value">{{ leave_request.employee.employment_info.department.department_name }}{% if leave_request.employee.employment_info.line.line_name %} ( {{ leave_request.employee.employment_info.line.line_name }} ){% endif %}</div>
            </div>
            <div>
                <div class="info-label">Date From:</div>
                <div class="info-value">{{ leave_request.date_from|date:"M d, Y" }}</div>
            </div>
            <div>
                <div class="info-label">Date To:</div>
                <div class="info-value">{{ leave_request.date_to|date:"M d, Y" }}</div>
            </div>
            <div>
                <div class="info-label">Leave Type:</div>
                <div class="info-value">{{ leave_request.leave_type.name }}</div>
            </div>
            <div>
                <div class="info-label">Days Requested:</div>
                <div class="info-value">{{ leave_request.days_requested }} days</div>
            </div>
            <div>
                <div class="info-label">Reason Category:</div>
                <div class="info-value">{{ leave_request.leave_reason.reason_text|default:"N/A" }}</div>
            </div>
            <div>
                <div class="info-label">Status:</div>
                <div class="info-value">
                    <span class="status-badge status-{{ leave_request.status }}">
                        {{ leave_request.get_status_display }}
                    </span>
                </div>
            </div>
            <div class="detail-full-width">
                <div class="info-label">Reason:</div>
                <div class="info-value">{{ leave_request.reason }}</div>
            </div>
        </div>
    </div>

    <hr class="employee-info-divider">

    <!-- Leave Balance Information -->
    {% if leave_request.leave_type.is_deducted %}
        {% if leave_request.status != 'disapproved' or leave_request.leave_type.is_deducted %}
        <div class="detail-section">
            <h4>Leave Balance Information</h4>
            <div class="balance-info">
                <div class="balance-summary">
                    <div class="balance-item">
                        <span class="balance-label">Total Available:</span>
                        <span class="balance-value {% if sufficient_balance %}text-success{% else %}text-danger{% endif %}">
                            {{ total_remaining }} days
                        </span>
                    </div>
                    <div class="balance-item">
                        <span class="balance-label">Requested:</span>
                        <span class="balance-value">{{ leave_request.days_requested }} days</span>
                    </div>
                    <div class="balance-item">
                        <span class="balance-label">After Approval:</span>
                        <span class="balance-value {% if sufficient_balance %}text-success{% else %}text-danger{% endif %}">
                            {% if sufficient_balance %}
                                {{ remaining_after_approval }} days
                            {% else %}
                                Insufficient Balance
                            {% endif %}
                        </span>
                    </div>
                </div>

                {% if leave_balances %}
                    <div class="balance-details">
                        <h5>Relevant Balance Breakdown ({{ leave_request.date_from|date:"M d, Y" }} - {{ leave_request.date_to|date:"M d, Y" }}):</h5>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                            <strong>Debug Info:</strong> Showing {{ leave_balances|length }} balance(s) that overlap with the leave request period.
                        </p>
                        <table class="balance-table">
                            <thead>
                                <tr>
                                    <th>Valid Period</th>
                                    <th style="text-align: center;">Entitled</th>
                                    <th style="text-align: center;">Used</th>
                                    <th style="text-align: center;">Remaining</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for balance in leave_balances %}
                                <tr>
                                    <td>{{ balance.valid_from|date:"M d, Y" }} - {{ balance.valid_to|date:"M d, Y" }}</td>
                                    <td style="text-align: center;">{{ balance.entitled }}</td>
                                    <td style="text-align: center;">{{ balance.used }}</td>
                                    <td style="text-align: center;">{{ balance.remaining }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}

                {% if not sufficient_balance %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> Employee does not have sufficient leave balance for this request.
                    </div>
                {% endif %}
            </div>
        </div>

        <hr class="employee-info-divider">
        {% endif %}
    {% endif %}

    <!-- Approval Timeline Section -->
    <div class="detail-section">
        <h4>Approval Timeline</h4>
        
        {% if leave_request.approval_actions.all %}
            <div class="timeline">
                {% for action in leave_request.approval_actions.all %}
                <div class="timeline-item">
                    <div class="timeline-marker status-{{ action.status }}">
                        {% if action.status == 'approved' %}
                            <i class="fa fa-check-circle"></i>
                        {% elif action.status == 'disapproved' %}
                            <i class="fa fa-times-circle"></i>
                        {% elif action.status == 'routing' %}
                            <i class="fas fa-clock"></i>
                        {% elif action.status == 'cancelled' %}
                            <i class="fa fa-exclamation-circle"></i>
                        {% else %}
                            <i class="fa fa-question-circle"></i>
                        {% endif %}
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            {% if action.action_at %}
                                <span class="timeline-date">{{ action.action_at|date:"d M" }}</span>
                                <span class="timeline-time">{{ action.action_at|date:"H:i" }}</span>
                            {% else %}
                                <span class="timeline-date">Pending</span>
                            {% endif %}
                        </div>
                        <div class="timeline-details">
                            <div class="user-header">
                                <img src="{{action.approver.avatar.url}}" alt="User Avatar" class="avatar" />
                                <div class="timeline-user-details">
                                    <span class="approver-name">{{action.approver.firstname}} {{action.approver.lastname}}</span>
                                    <span class="approver-position">{{action.approver.employment_info.position.position}}</span>
                                </div>
                            </div>
                            {% if action.comments %}
                                <div class="timeline-comments">{{ action.comments }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-history"></i>
                <p>No approval timeline available.</p>
            </div>
        {% endif %}
    </div>
</div>

<style>
.balance-info {
    margin-top: 15px;
}

.balance-summary {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
}

.balance-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.balance-label {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 5px;
}

.balance-value {
    font-size: 1.1em;
    font-weight: 600;
}

.text-success {
    color: #28a745;
}

.text-danger {
    color: #dc3545;
}

.text-warning {
    color: #ffc107;
}

.text-info {
    color: #17a2b8;
}

.balance-details {
    margin-top: 20px;
}

.balance-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.balance-table th,
.balance-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.balance-table th {
    background-color: #f8f9fa;
    font-weight: 600;
}

.alert {
    padding: 12px 16px;
    margin-top: 15px;
    border: 1px solid transparent;
    border-radius: 6px;
}

.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

.alert i {
    margin-right: 8px;
}
</style>
