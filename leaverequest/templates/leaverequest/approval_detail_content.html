{% load static %}
<link rel="stylesheet" href="{% static 'css/leave/leave.css' %}">

<div class="leave-detail-content">
    <!-- Header Section - Like Leave Request Details -->
    <div class="detail-header-section">
        <div class="detail-header-left">
            <span class="detail-control-number">LR-{{ leave_request.control_number }}</span>
            <span class="status-badge status-{{ leave_request.status }}">{{ leave_request.get_status_display }}</span>
        </div>
        <div class="detail-header-right">
            <span class="detail-submitted-date">Submitted: {{ leave_request.date_prepared|date:"M d, Y" }}</span>
        </div>
    </div>

    <!-- Basic Information Section -->
    <div class="detail-section">
        <div class="detail-section-header">
            <h4>Basic Information</h4>
        </div>
        
        <div class="employee-info-grid">
            <div>
                <div class="info-label">Requested By:</div>
                <div class="info-value">
                    <a href="#" class="employee-history-link" data-action="view-leave-history" data-employee-id="{{ leave_request.employee.id }}" data-employee-name="{{ leave_request.employee.firstname }} {{ leave_request.employee.lastname }}">
                        {{ leave_request.employee.firstname }} {{ leave_request.employee.lastname }}
                    </a>
                </div>
            </div>
            <div>
                <div class="info-label">Department/Line:</div>
                <div class="info-value">{{ leave_request.employee.employment_info.department.department_name }}{% if leave_request.employee.employment_info.line.line_name %} ( {{ leave_request.employee.employment_info.line.line_name }} ){% endif %}</div>
            </div>
            <div>
                <div class="info-label">Date From:</div>
                <div class="info-value">{{ leave_request.date_from|date:"M d, Y" }}</div>
            </div>
            <div>
                <div class="info-label">Date To:</div>
                <div class="info-value">{{ leave_request.date_to|date:"M d, Y" }}</div>
            </div>
            <div>
                <div class="info-label">Duration:</div>
                <div class="info-value">{{ leave_request.days_requested|floatformat:0 }} day{% if leave_request.days_requested != 1 %}s{% endif %}, {{ leave_request.hrs_requested|floatformat:0 }} hour{% if leave_request.hrs_requested != 1 %}s{% endif %}</div>
            </div>
            <div>
                <div class="info-label">Leave Type:</div>
                <div class="info-value">{{ leave_request.leave_type.name }}</div>
            </div>
            <div>
                <div class="info-label">Reason Category:</div>
                <div class="info-value">{{ leave_request.leave_reason.reason_text|default:"N/A" }}</div>
            </div>
            <div class="detail-full-width">
                <div class="info-label">Reason:</div>
                <div class="info-value">{{ leave_request.reason }}</div>
            </div>
        </div>
    </div>

    <!-- Leave Balance Information -->
    {% if leave_request.leave_type.is_deducted %}
        {% if leave_request.status != 'disapproved' or leave_request.leave_type.is_deducted %}
        <div class="detail-section">
            <div class="detail-section-header">
                <h4>Leave Balance Information</h4>
            </div>
            <div class="balance-info">
                <div class="balance-summary">
                    <div class="balance-item">
                        <span class="balance-label">Total Available:</span>
                        <span class="balance-value {% if sufficient_balance %}text-success{% else %}text-danger{% endif %}">
                            {{ total_remaining }} days
                        </span>
                    </div>
                    <div class="balance-item">
                        <span class="balance-label">Requested:</span>
                        <span class="balance-value">{{ leave_request.days_requested }} days</span>
                    </div>
                    <div class="balance-item">
                        <span class="balance-label">After Approval:</span>
                        <span class="balance-value {% if sufficient_balance %}text-success{% else %}text-danger{% endif %}">
                            {% if sufficient_balance %}
                                {{ remaining_after_approval }} days
                            {% else %}
                                Insufficient Balance
                            {% endif %}
                        </span>
                    </div>
                </div>

                {% if leave_balances %}
                    <div class="balance-details">
                        <h5>Relevant Balance Breakdown ({{ leave_request.date_from|date:"M d, Y" }} - {{ leave_request.date_to|date:"M d, Y" }}):</h5>
                        <table class="balance-table">
                            <thead>
                                <tr>
                                    <th>Valid Period</th>
                                    <th style="text-align: center;">Entitled</th>
                                    <th style="text-align: center;">Used</th>
                                    <th style="text-align: center;">Remaining</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for balance in leave_balances %}
                                <tr>
                                    <td>{{ balance.valid_from|date:"M d, Y" }} - {{ balance.valid_to|date:"M d, Y" }}</td>
                                    <td style="text-align: center;">{{ balance.entitled }}</td>
                                    <td style="text-align: center;">{{ balance.used }}</td>
                                    <td style="text-align: center;">{{ balance.remaining }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}

                {% if not sufficient_balance %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> Employee does not have sufficient leave balance for this request.
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    {% endif %}

    <!-- Approval Status Section -->
    <div class="detail-section">
        <div class="detail-section-header">
            <h4>Approval Status</h4>
        </div>
        
        {% if leave_request.approval_actions.all %}
            <div class="approval-timeline">
                {% for action in leave_request.approval_actions.all %}
                <div class="approval-timeline-item {% if forloop.last %}last{% endif %}">
                    <div class="approval-timeline-marker status-{{ action.status }}">
                        {% if action.status == 'approved' %}
                            <i class="fa fa-check-circle"></i>
                        {% elif action.status == 'disapproved' %}
                            <i class="fa fa-times-circle"></i>
                        {% elif action.status == 'routing' %}
                            <i class="fas fa-clock"></i>
                        {% elif action.status == 'cancelled' %}
                            <i class="fa fa-exclamation-circle"></i>
                        {% else %}
                            <i class="fa fa-check-circle"></i>
                        {% endif %}
                    </div>
                    <div class="approval-timeline-content">
                        <div class="approval-timeline-title">
                            {{ action.approver.firstname }}, {{ action.approver.lastname }} - 
                            {% if action.status == 'approved' %}
                                Approved
                            {% elif action.status == 'disapproved' %}
                                Disapproved
                            {% elif action.status == 'routing' %}
                                Pending Approval
                            {% elif action.status == 'cancelled' %}
                                Cancelled
                            {% else %}
                                Submitted
                            {% endif %}
                        </div>
                        <div class="approval-timeline-subtitle">
                            {% if action.status == 'routing' %}
                                Waiting for {{ action.approver.firstname }}, {{ action.approver.lastname }}'s approval
                            {% else %}
                                {% if action.action == 'submitted' %}
                                    Submitted by {{ action.approver.firstname }}, {{ action.approver.lastname }} on {{ action.action_at|date:"M d, Y" }}, {{ action.action_at|date:"g:i A" }}
                                {% else %}
                                    {{ action.get_status_display }} by {{ action.approver.firstname }}, {{ action.approver.lastname }} on {{ action.action_at|date:"M d, Y" }}, {{ action.action_at|date:"g:i A" }}
                                {% endif %}
                            {% endif %}
                        </div>
                        {% if action.comments and action.comments != 'Updated my leave request' %}
                            <div class="approval-timeline-comments">"{{ action.comments }}"</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-history"></i>
                <p>No approval status available.</p>
            </div>
        {% endif %}
    </div>
</div>

<style>
.balance-info {
    margin-top: 15px;
}

.balance-summary {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: var(--bg-secondary);
    border-radius: 6px;
}

.balance-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.balance-label {
    font-size: 0.9em;
    color: var(--text-secondary);
    margin-bottom: 5px;
}

.balance-value {
    font-size: 1.1em;
    font-weight: 600;
}

.text-success {
    color: #28a745;
}

.text-danger {
    color: #dc3545;
}

.text-warning {
    color: #ffc107;
}

.text-info {
    color: #17a2b8;
}

.balance-details {
    margin-top: 20px;
}

.balance-details h5 {
    font-size: 0.95em;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 10px;
}

.balance-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.balance-table th,
.balance-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.balance-table th {
    background-color: var(--bg-secondary);
    font-weight: 600;
}

.alert {
    padding: 12px 16px;
    margin-top: 15px;
    border: 1px solid transparent;
    border-radius: 6px;
}

.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

.alert i {
    margin-right: 8px;
}
</style>
