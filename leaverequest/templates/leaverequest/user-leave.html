{% extends "main.html" %}
{% load static %}

{% block title %}REPConnect - Leave Management{% endblock title %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/leave/leave.css' %}">
{% endblock %}

{% block content %}
<div class="page-content" id="page-content">
    <header class="page-header">
        <div class="page-header-content">
            <h2>Leave Management</h2>
            <p>Manage your leave requests and track balances</p>
        </div>
        <div class="page-actions">
            <button class="btn btn-primary" data-action="apply-leave">
                <i class="fas fa-plus"></i>
                Apply for Leave
            </button>
        </div>
    </header>

    <!-- Main Content Tabs -->
    <div class="leave-section">
        <div class="tabs-horizontal" data-tour="tabs-section">
            <div class="tab-list">
                <button class="tab active" data-target="overview">Overview</button>
                <button class="tab" data-target="my-requests">My Requests</button>
                {% if is_approver %}
                    <button class="tab" data-target="approvals">
                        My Approvals
                        {% if pending_routing_count %}
                            <span class="notification-badge">{{ pending_routing_count }}</span>
                        {% endif %}
                    </button>
                {% endif %}
            </div>
        </div>

        <div id="overview" class="tab-panel active">
            <!-- Chart and Graph -->
            <div class="overview-two-column">
                    <div class="chart-grid">
                        <div class="chart-card">
                            <div class="chart-card-header">
                                <h4>Status Distribution</h4>
                                <span class="chart-subtitle" id="fiscalYearDuration">Fiscal Year: Loading...</span>
                            </div>
                            <div class="chart-container">
                                <div class="donut-chart-wrapper">
                                    <div class="chart-legend" id="statusChartLegend">
                                    </div>
                                    <div class="donut-chart-container">
                                        <canvas id="statusChart"></canvas>
                                        <div class="donut-center">
                                            <div class="donut-center-number">0</div>
                                            <div class="donut-center-label">Total Requests</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-card-header">
                                <h4>Leave Trend</h4>
                                <span class="chart-subtitle" id="fiscalYearDuration2">Fiscal Year: Loading...</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="leaveTypesChart"></canvas>
                            </div>
                        </div>
                    </div>
            </div>

            <!-- Totals, Calendar and Activities -->
            <div class="overview-two-column">
                    <div class="overview-left-column">
                        {% if request.user.employment_info.employment_type == 'Regular' and leave_balance_sets %}
                        <div class="leave-balance-summary">                   
                                {% for set in leave_balance_sets %}
                                    <div class="balance-set-card">
                                        <div class="balance-set-card-header">
                                            <div class="balance-period-info">
                                                <span class="balance-period-text">
                                                    {{ set.valid_from|date:"M d, Y" }} - {{ set.valid_to|date:"M d, Y" }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="balance-set-card-body">
                                            <div class="balance-list">
                                                {% for balance in set.balances %}
                                                <div class="leave-balance-card">
                                                    <div class="leave-balance-icon">
                                                        {% if balance.leave_type.code == 'SL' %}
                                                            <div class="leave-balance-icon-circle green">
                                                                <i class="fas fa-thermometer-half"></i>
                                                            </div>   
                                                        {% elif balance.leave_type.code == 'VL' %}
                                                            <div class="leave-balance-icon-circle blue">
                                                                <i class="fas fa-plane"></i>
                                                            </div> 
                                                        {% elif balance.leave_type.code == 'EL' %}
                                                            <div class="leave-balance-icon-circle orange">
                                                                <i class="fas fa-briefcase"></i>
                                                            </div>        
                                                        {% else %}
                                                            <div class="leave-balance-icon-circle red">
                                                                <i class="fas fa-calendar"></i>
                                                            </div>                          
                                                        {% endif %}
                                                    </div>
                                                    <div class="leave-balance-main-row">
                                                        <div class="leave-balance-info">
                                                            <span class="leave-balance-title">{{ balance.leave_type.name }}</span>
                                                            <span class="leave-balance-id">({{ balance.leave_type.code }})</span>
                                                        </div>
                                                        <div class="leave-balance-info-row">
                                                            <span class="leave-balance-remaining"><i class="fas fa-gift"></i> {{ balance.entitled|floatformat:2 }}</span>
                                                            <span class="leave-balance-remaining"><i class="fas fa-minus-circle"></i> {{ balance.used|floatformat:2 }}</span>
                                                            <span class="leave-balance-remaining"><i class="fas fa-check-circle"></i> {{ balance.remaining|floatformat:2 }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                        </div>
                        {% else %}
                        <div class="recent-activities">
                            <h4>Leave Balances</h4>
                            <div class="activity-list">
                                <div class="empty-state">
                                    <i class="fas fa-calendar-times"></i>
                                    <h4>No leave balances</h4>
                                    <p>Leave balances data not available yet.</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="overview-right-column">
                        <div class="leave-calendar-container">
                            <!-- Calendar Header -->
                            <div class="calendar-header">
                                <div class="calendar-view-controls">
                                    <button class="btn btn-outline" onclick="goToToday()">Today</button>
                                </div>
                                <div class="calendar-date-range">
                                    <button class="btn btn-outline" data-nav="prev" onclick="changeMonth(-1)">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <span class="date-range-text" id="currentMonth">November 2024</span>
                                    <button class="btn btn-outline" data-nav="next" onclick="changeMonth(1)">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Calendar Grid -->
                            <div class="calendar-grid">
                                <div class="calendar-weekdays">
                                    <div class="weekday">Sun</div>
                                    <div class="weekday">Mon</div>
                                    <div class="weekday">Tue</div>
                                    <div class="weekday">Wed</div>
                                    <div class="weekday">Thu</div>
                                    <div class="weekday">Fri</div>
                                    <div class="weekday">Sat</div>
                                </div>
                                <div class="calendar-days" id="calendar-days">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overview-left-column">
                        <div class="recent-activities">
                            <h4>Recent Activities</h4>
                            <div class="activity-list">
                                {% if recent_leaves %}
                                    {% for leave in recent_leaves %}
                                    <div class="activity-item status-{{ leave.status }}">
                                        <div class="reminder-icon status-{{ leave.status }}">
                                            {% if leave.status == 'approved' %}
                                                <i class="fa fa-check-circle"></i>
                                            {% elif leave.status == 'disapproved' %}
                                                <i class="fa fa-times-circle"></i>
                                            {% elif leave.status == 'routing' %}
                                                <i class="fas fa-clock"></i>
                                            {% else %}
                                                <i class="fa fa-ban"></i>
                                            {% endif %}
                                        </div>
                                        <div class="activity-content">
                                            <div class="activity-title">
                                                {% if leave.status == 'approved' %}
                                                    Leave request approved
                                                {% elif leave.status == 'disapproved' %}
                                                    Leave request disapproved
                                                {% elif leave.status == 'routing' %}
                                                    Leave request pending approval
                                                {% else %}
                                                    Leave request {{ leave.get_status_display|lower }}
                                                {% endif %}
                                            </div>
                                            <div class="activity-meta">
                                                {{ leave.leave_type.name }} â€¢ {{ leave.duration_display }}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="empty-state">
                                        <i class="fas fa-inbox"></i>
                                        <h4>No recent activities</h4>
                                        <p>Apply for leave to see activities here</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
            </div>
        </div>

        <div id="my-requests" class="tab-panel">
            {% if my_requests_page_obj %}
            <div class="leave-table-container">
                <table class="data-table">
                    <thead>
                            <tr>
                                <th class="leave-hide-column">Control Number</th>
                                <th class="leave-hide-column">Date Prepared</th>
                                <th>Leave Type</th>
                                <th class="leave-hide-column">Leave Reason</th>
                                <th>Duration</th>
                                <th class="leave-hide-column">Status</th>
                                <th style="text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="myRequestsTable">
                            {% for leave in my_requests_page_obj %}
                            <tr>
                                <td class="leave-hide-column">
                                    <span class="control-number">LR-{{ leave.control_number }}</span>
                                </td>
                                <td class="leave-hide-column">{{ leave.date_prepared|date:"M d, Y" }}</td>
                                <td>{{ leave.leave_type.name }}</td>
                                <td class="leave-hide-column">{{ leave.leave_reason.reason_text }}</td>
                                <td>{{ leave.duration_display }}</td>
                                <td class="center-align leave-hide-column">
                                    <span class="status-badge status-{{ leave.status }}">
                                        {{ leave.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    <div class="center-align">
                                        <button class="btn btn-icon " data-action="view-details" data-control-number="{{ leave.control_number }}" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if leave.status == 'routing' %}
                                        <button class="btn btn-icon btn-error" data-action="cancel-leave" data-control-number="{{ leave.control_number }}" title="Cancel">
                                            <i class="fa fa-times-circle"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="empty-state">
                                        <i class="fas fa-calendar-alt"></i>
                                        <p>No leave requests found.</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
            </div>
            <div class="pagination" id="paginationContainer">
                <div class="pagination-info">
                    Showing <span id="startRecord">{{ my_requests_page_obj.start_index }}</span> to <span id="endRecord">{{ my_requests_page_obj.end_index }}</span> of <span id="totalRecords">{{ my_requests_page_obj.paginator.count }}</span> entries
                </div>
                <div class="pagination-controls" id="paginationControls">
                    {% if my_requests_page_obj.has_previous %}
                        <a class="pagination-btn" id="prevPage" href="?page={{ my_requests_page_obj.previous_page_number }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    {% else %}
                        <span class="pagination-btn" id="prevPage" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </span>
                    {% endif %}
                    <div id="pageNumbers">
                        {% for num in my_requests_page_obj.paginator.page_range %}
                            {% if my_requests_page_obj.number == num %}
                                <span class="pagination-btn active">{{ num }}</span>
                            {% elif num > my_requests_page_obj.number|add:'-3' and num < my_requests_page_obj.number|add:'3' %}
                                <a class="pagination-btn" href="?page={{ num }}">{{ num }}</a>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% if my_requests_page_obj.has_next %}
                        <a class="pagination-btn" id="nextPage" href="?page={{ my_requests_page_obj.next_page_number }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    {% else %}
                        <span class="pagination-btn" id="nextPage" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fa fa-folder-open"></i>
                <h5>No filed leave requests</h5>
                <p>You don't have a filed leave at the moment.</p>
            </div>
            {% endif %}
        </div>

        {% if is_approver %}
        <div id="approvals" class="tab-panel">
            <div class="overview-two-column">
                    <div class="chart-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h4>Leave Request Distribution</h4>
                            </div>
                            <div class="chart-container">
                                <div class="donut-chart-wrapper">
                                    <div class="chart-legend" id="approvalDistributionLegend">
                                    </div>
                                    <div class="donut-chart-container">
                                        <canvas id="LeaveDistributionChart"></canvas>
                                        <div class="donut-center">
                                            <div class="donut-center-number">0</div>
                                            <div class="donut-center-label">Total Requests</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <h4>Leave Request Trend</h4>
                                <div class="chart-controls">
                                    <div class="chart-filters" id="approval-trend-filters">
                                        <button class="filter-btn active" data-period="month">This Month</button>
                                        <button class="filter-btn" data-period="quarter">This Quarter</button>
                                        <button class="filter-btn" data-period="year">This Year</button>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="leaveRequestChart"></canvas>
                            </div>
                        </div>
                    </div>
            </div>

            <div class="table-actions table-actions-bar">
                <div class="table-actions-left" data-intro="Search for employees by name, ID number, or email" data-step="8">
                    <form class="search-box">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search leave requests..." name="search" value="{{ search_query }}" />
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        {% if search_query %}
                        <span class="search-clear" onclick="clearSearch()">
                            <i class="fas fa-times"></i>
                        </span>
                        {% endif %}
                    </form>
                </div>
            </div>

            <div class="leave-table-container" id="approvalsTableContainer">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="leave-hide-column">Control Number</th>
                                <th>Employee</th>
                                <th>Leave Type</th>
                                <th class="leave-hide-column">Leave Reason</th>
                                <th class="leave-hide-column">Duration</th>
                                <th>Status</th>
                                <th class="leave-hide-column">Date Submitted</th>
                                <th style="text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="approvalsTableBody">
                            {% if pending_approvals %}
                                {% for approval in pending_approvals %}
                                    <tr>
                                        <td class="leave-hide-column">
                                            <span class="control-number">LR-{{ approval.leave_request.control_number }}</span>
                                        </td>
                                        <td>
                                            <div class="employee-info">
                                                <span class="employee-name">{{ approval.leave_request.employee.full_name }}</span>
                                                <small class="employee-id">{{ approval.leave_request.employee.idnumber }}</small>
                                            </div>
                                        </td>
                                        <td>{{ approval.leave_request.leave_type.name }}</td>
                                        <td class="leave-hide-column">{{ approval.leave_request.leave_reason.reason_text }}</td>
                                        <td class="leave-hide-column">{{ approval.leave_request.duration_display }}</td>
                                        <td class="center-align">
                                            <span class="status-badge status-{{ approval.status }}">
                                                {% if approval.status == 'routing' %}Waiting for your approval{% else %}{{ approval.get_status_display }}{% endif %}
                                            </span>
                                        </td>
                                        <td class="leave-hide-column">{{ approval.leave_request.date_prepared|date:"M d, Y" }}</td>
                                        <td>
                                            <div class="center-align">
                                                {% if approval.status != 'routing' %}
                                                    <button class="btn btn-icon " data-action="view-details" data-control-number="{{ approval.leave_request.control_number }}" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                {% else %}
                                                    <button class="btn btn-sm btn-primary" data-action="open-approval" data-control-number="{{ approval.leave_request.control_number }}" title="Review & Approve">
                                                        <i class="fas fa-check"></i>
                                                        Review
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="empty-state">
                                            <i class="fas fa-search"></i>
                                            <h5>No leave requests found</h5>
                                            {% if search_query %}
                                                <p>No results found for "{{ search_query }}"</p>
                                            {% else %}
                                                <p>No pending approvals at this time.</p>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
            </div>

            <div class="pagination" id="approvalsPaginationContainer">
                <div class="pagination-info">
                    <span id="approvalsStartRecord">{{ pending_approvals.start_index|default:0 }}</span> to <span id="approvalsEndRecord">{{ pending_approvals.end_index|default:0 }}</span> of <span id="approvalsTotalRecords">{{ pending_approvals.paginator.count|default:0 }}</span> entries
                </div>
                <div class="pagination-controls" id="approvalsPaginationControls">
                    {% if pending_approvals.has_previous %}
                        <a class="pagination-btn" id="approvalsPrevPage" href="?approvals_page={{ pending_approvals.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}#approvals">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    {% else %}
                        <span class="pagination-btn" id="approvalsPrevPage" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </span>
                    {% endif %}
                    <div id="approvalsPageNumbers">
                        {% if pending_approvals.paginator.page_range %}
                            {% for num in pending_approvals.paginator.page_range %}
                                {% if pending_approvals.number == num %}
                                    <span class="pagination-btn active">{{ num }}</span>
                                {% elif num > pending_approvals.number|add:'-3' and num < pending_approvals.number|add:'3' %}
                                    <a class="pagination-btn" href="?approvals_page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}#approvals">{{ num }}</a>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <span class="pagination-btn active">1</span>
                        {% endif %}
                    </div>
                    {% if pending_approvals.has_next %}
                        <a class="pagination-btn" id="approvalsNextPage" href="?approvals_page={{ pending_approvals.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}#approvals">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    {% else %}
                        <span class="pagination-btn" id="approvalsNextPage" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Apply Leave Modal -->
<div id="applyLeaveModal" class="modal modal-md">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Apply for Leave</h3>
            <button class="modal-close" data-action="close-modal" data-modal="applyLeaveModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="applyLeaveForm" method="post" action="{% url 'apply' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-body">
                <div class="form-row form-row-2col">
                    <div class="form-group">
                        <label for="id_date_from">Date From <span style="color: red;">*</span></label>
                        <input type="date" name="date_from" id="id_date_from" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="id_date_to">Date To <span style="color: red;">*</span></label>
                        <input type="date" name="date_to" id="id_date_to" class="form-control" required>
                    </div>
                </div>

                <!-- Leave Counts Preview -->
                <div class="form-row days-hidden"> 
                    <div class="form-group">
                        <div id="daysRequested" class="days-display">
                            <div class="days-info">
                                <span class="days-count" id="daysCount">Select dates to calculate</span>
                                <small class="days-range" id="daysRange"></small>
                            </div>
                            <div class="days-info">
                                <span class="days-count" id="hrsCount">Hours Count</span>
                                <small class="days-range" id="hrsRange">7:00 AM to 4:00 PM</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row form-row-2col">
                    <div class="form-group">
                        <label for="id_leave_type">Leave Type <span style="color: red;">*</span></label>
                        <select name="leave_type" id="id_leave_type" class="form-control" required>
                            <option value="">Select Leave Type</option>
                            {% for leave_type in leave_types %}
                            <option value="{{ leave_type.id }}">{{ leave_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_leave_reason">Reason Category <span style="color: red;">*</span></label>
                        <select name="leave_reason" id="id_leave_reason" class="form-control" required disabled>
                            <option value="">Select Leave Reason</option>
                            {% for leave_reason in leave_reasons %}
                            <option value="{{ leave_reason.id }}">{{ leave_reason.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="id_reason">Reason for Leave <span style="color: red;">*</span></label>
                    <textarea name="reason" id="id_reason" class="form-control" rows="4" placeholder="Please provide the reason for your leave request..." required></textarea>
                </div>
                <input type="hidden" name="hrs_requested" id="id_hrs_requested" value="0">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" data-action="close-modal" data-modal="applyLeaveModal">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    Submit Request
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Leave Details Modal -->
<div id="leaveDetailsModal" class="modal modal-md">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Leave Request Details</h3>
            <button class="modal-close" data-action="close-modal" data-modal="leaveDetailsModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="leaveDetailsContent">
            <!-- Content loaded via AJAX -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" data-action="close-modal" data-modal="leaveDetailsModal">Close</button>
            <button type="button" class="btn btn-outline" data-action="close-modal" data-modal="leaveDetailsModal">Cancel</button>
        </div>
    </div>
</div>

<!-- Approval Modal -->
<div id="approvalModal" class="modal modal-md">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h4>Review Leave Request</h4>
            <button class="modal-close" data-action="close-modal" data-modal="approvalModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="approvalContent">
            <!-- Content loaded via AJAX -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" data-action="close-modal" data-modal="approvalModal">Cancel</button>
            <button type="button" class="btn btn-error" data-action="process-approval" data-approval-action="disapprove">
                <i class="fas fa-times"></i>
                Disapprove
            </button>
            <button type="button" class="btn btn-success" data-action="process-approval" data-approval-action="approve">
                <i class="fas fa-check"></i>
                Approve
            </button>
        </div>
    </div>
</div>

<!-- No Approver Error Modal -->
<div id="noApproverModal" class="modal modal-md">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h4>Approver Not Assigned</h4>
            <button class="modal-close" data-action="close-modal" data-modal="noApproverModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="alert alert-warning" style="display: flex; flex-direction: column;">
                <p><strong>Action Required:</strong> You cannot proceed with this request.</p>
                <p>
                    It looks like you don't have an assigned approver yet. To continue, please assign an approver in your profile.
                    Click the <strong>"Assign Approver"</strong> button below to update your profile.
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" data-action="close-modal" data-modal="noApproverModal">Close</button>
            <a href="{% url 'user_profile' %}" class="btn btn-primary">
                <i class="fas fa-user-cog"></i>
                Assign Approver
            </a>
        </div>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div id="cancelConfirmModal" class="modal modal-md">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirm Cancellation</h3>
            <button class="modal-close" data-action="close-modal" data-modal="cancelConfirmModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to cancel this leave request?</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" data-action="close-modal" data-modal="cancelConfirmModal">No</button>
            <button type="button" class="btn btn-error" id="confirmCancelBtn">Yes, Cancel</button>
        </div>
    </div>
</div>

<!-- Leave History Modal -->
<div id="leaveHistoryModal" class="modal modal-md">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="leaveHistoryModalTitle">Leave History</h3>
            <button class="modal-close" data-action="close-modal" data-modal="leaveHistoryModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="leaveHistoryContent">
            <!-- Content loaded via AJAX -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" data-action="close-modal" data-modal="leaveHistoryModal">Close</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toast-container" style="position: fixed !important; bottom: 20px !important; right: 20px !important; top: auto !important; left: auto !important; z-index: 10000 !important;"></div>

{% endblock content %}

{% block extra_js %}
<script>
    window.leaveCalendarData = [
        {% if recent_leaves %}
        {% for leave in recent_leaves %}
        {
            startDate: '{{ leave.date_from|date:"Y-m-d" }}',
            endDate: '{{ leave.date_to|date:"Y-m-d" }}',
            leaveType: '{{ leave.leave_type.name|escapejs }}',
            reason: '{{ leave.reason|escapejs|truncatechars:50 }}',
            code: '{{ leave.leave_type.code|escapejs }}',
            controlNumber: '{{ leave.control_number|escapejs }}',
            status: '{{ leave.status|escapejs }}'
        },
        {% endfor %}
        {% endif %}
    ];
</script>
<script src="{% static 'js/leave/user_leave.js' %}"></script>
{% endblock extra_js %}