{% extends "main.html" %}
{% load static %}
{% csrf_token %}

{% block title %}REPConnect - Evaluation Management{% endblock title %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/evaluation/evaluation.css' %}">
    <link rel="stylesheet" href="{% static 'css/training/training.css' %}">
    <link rel="stylesheet" href="{% static 'css/survey/survey.css' %}">
{% endblock %}

{% block content %}

<div class="page-content">
        <div class="page-header">
            <div class="page-header-content">
                <h1 class="page-title">Employee Evaluation Management</h1>
                <p class="page-subtitle">Oversee, review, and track employee performance evaluations</p>
            </div>
        </div>

        <div class="dashboard-stats-container">
            <div class="dashboard-stats">
                <div class="modern-stats-grid">
                    <div class="modern-stat-card">
                        <div class="modern-stat-icon blue">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="modern-stat-label">Total Evaluations</div>
                        <div class="modern-stat-value">{{ total_trainings }}</div>
                        <div class="modern-stat-change {% if trainings_positive %}positive{% else %}negative{% endif %}">
                            <span class="modern-stat-change-icon">
                                <i class="fas {% if trainings_positive %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
                            </span>
                            {{ trainings_percent|floatformat:1 }}%
                            <span class="modern-stat-change-text">vs prev. month</span>
                        </div>
                    </div>
                    <div class="modern-stat-card">
                        <div class="modern-stat-icon green">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <div class="modern-stat-label">Active Evaluations</div>
                        <div class="modern-stat-value">{{ active_trainings }}</div>
                        <div class="modern-stat-change {% if active_positive %}positive{% else %}negative{% endif %}">
                            <span class="modern-stat-change-icon">
                                <i class="fas {% if active_positive %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
                            </span>
                            {{ active_percent|floatformat:1 }}%
                            <span class="modern-stat-change-text">vs prev. month</span>
                        </div>
                    </div>
                    <div class="modern-stat-card">
                        <div class="modern-stat-icon orange">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="modern-stat-label">Completed Evaluations</div>
                        <div class="modern-stat-value">{{ completed_evaluations }}</div>
                        <div class="modern-stat-change {% if completed_positive %}positive{% else %}negative{% endif %}">
                            <span class="modern-stat-change-icon">
                                <i class="fas {% if completed_positive %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
                            </span>
                            {{ completed_percent|floatformat:1 }}%
                            <span class="modern-stat-change-text">vs prev. month</span>
                        </div>
                    </div>
                    <div class="modern-stat-card">
                        <div class="modern-stat-icon red">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="modern-stat-label">Pending Evaluations</div>
                        <div class="modern-stat-value">{{ pending_responses }}</div>
                        <div class="modern-stat-change {% if pending_positive %}positive{% else %}negative{% endif %}">
                            <span class="modern-stat-change-icon">
                                <i class="fas {% if pending_positive %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
                            </span>
                            {{ pending_percent|floatformat:1 }}%
                            <span class="modern-stat-change-text">vs prev. month</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="overview-two-column">
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Evaluation Performance Analytics</h3>
                    <div class="chart-controls">
                        <div class="chart-filters has-active slide-0">
                            <button class="filter-btn active" data-period="month">Monthly</button>
                            <button class="filter-btn" data-period="quarter">Quarterly</button>
                            <button class="filter-btn" data-period="year">Yearly</button>
                        </div>
                        <div class="chart-type-filters has-active slide-0">
                            <button class="chart-type-btn active" data-type="line">
                                <i class="fas fa-chart-line"></i>
                            </button>
                            <button class="chart-type-btn" data-type="bar">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="evaluationChart"></canvas>
                </div>
            </div>
        </div>

        <div class="overlay-two-column">
            <div class="tabs-horizontal" data-tour="tabs-section">
                <div class="tab-list">
                    <button class="tab active" data-target="evaluation">Evaluation</button>
                    <button class="tab" data-target="tasklist">Tasklists</button>
                </div>
            </div>  

            <div id="evaluation" class="tab-panel active">
                <div class="table-actions table-actions-bar">
                    <div class="table-actions-left" data-intro="Search for employees by name, ID number, or email" data-step="8">
                        <div class="search-box">
                            <input type="text" class="search-input" id="trainingSearchInput" placeholder="Search evaluations..." name="search" value="{{ search }}" />
                            <span class="search-icon"><i class="fas fa-search"></i></span>
                            <span class="search-clear" style="display: none;">
                                <i class="fas fa-times"></i>
                            </span>
                        </div>
                    </div>
                    <div class="table-actions-right" style="position:relative;">
                        <button class="btn btn-action"  onclick="openCreateEvaluationModal()">
                            <i class="fas fa-plus"></i>
                            Create Evaluation
                        </button>
                    </div>                        
                </div>

                <div class="common-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fiscal Year</th>
                                        <th>Evaluation Title</th>
                                        <th class="hide-column">Description</th>
                                        <th>Duration</th>
                                        <th style="text-align:center;" class="hide-column">Completion Rate</th>
                                        <th class="hide-column" style="text-align:center;">Status</th>
                                        <th style="text-align:center;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="evaluationTableBody">
                                    {% include 'evaluation/partials/evaluation_table_rows.html' %}
                                </tbody>
                            </table>
                        </div>

                    <div class="pagination" id="paginationContainer">
                        {% include 'evaluation/partials/evaluation_pagination.html' with page_obj=page_obj search=search %}
                </div> 
            </div>

            <div id="tasklist" class="tab-panel">
                <div class="table-actions table-actions-bar">
                    <div class="table-actions-left" data-intro="Search for employees by name, ID number, or email" data-step="8">
                        <div class="search-box">
                            <input type="text" class="search-input" id="trainingSearchInput" placeholder="Search users..." name="search" value="{{ search }}" />
                            <span class="search-icon"><i class="fas fa-search"></i></span>
                            <span class="search-clear" style="display: none;">
                                <i class="fas fa-times"></i>
                            </span>
                        </div>
                    </div>    
                    <div class="table-actions-right" style="position:relative;">
                        <button class="btn btn-action"  onclick="openTasklistImportModal()">
                            <i class="fa fa-upload"></i>
                            Import Tasklist
                        </button>
                    </div>                            
                </div>

                <div class="common-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Id Number</th>
                                        <th>Name</th>
                                        <th class="hide-column">Department</th>
                                        <th class="hide-column">Line</th>
                                        <th class="hide-column">Approver</th>
                                        <th style="text-align:center;">Status</th>
                                        <th style="text-align:center;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="tasklistTableBody">
                                    {% include 'evaluation/partials/tasklist_table_rows.html' %}
                                </tbody>
                            </table>
                        </div>

                    <div class="pagination" id="paginationContainer">
                        {% include 'evaluation/partials/evaluation_pagination.html' with page_obj=users_page_obj search=search %}
                </div> 
            </div>
        </div>
</div>

    <!-- Create Evaluation Modal -->
    <div id="createEvaluationModal" class="modal modal-md">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h4>Create New Evaluation</h4>
                <button class="modal-close" onclick="closeModal('createEvaluationModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createEvaluationForm" method="post" action="{% url 'create_evaluation' %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label class="form-label">Evaluation Title</label>
                        <input type="text" name="title" class="form-input" placeholder="Enter evaluation title" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-input" placeholder="Enter evaluation description" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group form-group-half">
                            <label class="form-label">Start Year</label>
                            <input type="number" name="start_year" class="form-input" placeholder="2025" min="2020" max="2040" required>
                            <small class="form-help">Fiscal year start (May)</small>
                        </div>
                        <div class="form-group form-group-half">
                            <label class="form-label">End Year</label>
                            <input type="number" name="end_year" class="form-input" placeholder="2026" min="2021" max="2041" required>
                            <small class="form-help">Fiscal year end (April)</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Duration</label>
                        <select name="duration" class="form-input" required>
                            <option value="">Select duration</option>
                            <option value="daily">Daily</option>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('createEvaluationModal')">Cancel</button>
                <button type="submit" form="createEvaluationForm" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Create Evaluation
                </button>
            </div>
        </div>
    </div>

    <!-- Evaluation Details Modal -->
    <div id="trainingDetailsModal" class="modal modal-lg">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="trainingDetailsTitle">Evaluation Details</h4>
                <button class="modal-close" onclick="closeModal('trainingDetailsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="trainingDetailsContent">
                    <!-- Evaluation details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('trainingDetailsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Tasklist Import Modal -->
    <div id="tasklistImportModal" class="modal modal-md">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h4>Import Tasklist</h4>
                <button class="modal-close" onclick="closeModal('tasklistImportModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="import-actions-header">
                    <p class="import-description">Upload tasklist files (XLSX, XLS, CSV). You can upload multiple files at once.</p>
                    <a class="btn btn-sm btn-outline" href="{% url 'export_tasklist_template' %}" download>
                        <i class="fas fa-download"></i>
                        Download Template
                    </a>
                </div>
                <div class="file-upload-area" id="tasklist-upload-area">
                    <form id="tasklist-upload-form" action="{% url 'upload_tasklist' %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="file-upload">
                            <input type="file" id="tasklist-files" name="files" multiple class="file-input" accept=".xlsx,.xls,.csv">
                            <label for="tasklist-files" class="file-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Drag & drop tasklist files here or click to browse</span>
                                <small>Supported formats: .xlsx, .xls, .csv (Max size: 10MB)</small>
                            </label>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" form="tasklist-upload-form" class="btn btn-primary" id="tasklist-upload-btn">
                    <i class="fas fa-upload"></i>
                    Upload Files
                </button>
                <button class="btn btn-outline" onclick="closeModal('tasklistImportModal')">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- View User Tasklists Modal -->
    <div id="viewTasklistModal" class="modal modal-lg">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="tasklistModalTitle">User Tasklists</h4>
                <button class="modal-close" onclick="closeModal('viewTasklistModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="tasklistContent" class="tasklist-container">
                    <!-- Tasklist content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('viewTasklistModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal modal-md">
        <div class="modal-overlay" onclick="closeModal('deleteConfirmModal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h4>Confirm Delete</h4>
                <button class="modal-close" onclick="closeModal('deleteConfirmModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="confirmation-content">
                    <div class="confirmation-icon">
                        <i class="fas fa-exclamation-triangle icon-warning"></i>
                    </div>
                    <div class="confirmation-message">
                        <h5>Confirm Delete Evaluation</h5>
                        <p>Are you sure you want to delete this evaluation?</p>
                        <p class="delete-details" id="deleteTrainingName"></p>
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i>
                            This action cannot be undone and will remove all associated evaluation responses.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('deleteConfirmModal')">Cancel</button>
                <button id="confirmDeleteBtn" class="btn btn-error">
                    <i class="fas fa-trash"></i>
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <div id="editEvaluationModal" class="modal modal-md">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h4>Edit Evaluation</h4>
                <button class="modal-close" onclick="closeModal('editEvaluationModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="editEvaluationForm">
                    {% csrf_token %}
                    <input type="hidden" name="evaluation_id" id="edit_evaluation_id">
                    <div class="form-group">
                        <label class="form-label">Evaluation Title</label>
                        <input type="text" name="title" id="edit_title" class="form-input" placeholder="Enter evaluation title" required="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea name="description" id="edit_description" class="form-input" placeholder="Enter evaluation description" rows="3" required=""></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group form-group-half">
                            <label class="form-label">Start Year</label>
                            <input type="number" name="start_year" id="edit_start_year" class="form-input" min="2020" max="2040" required="">
                        </div>
                        <div class="form-group form-group-half">
                            <label class="form-label">End Year</label>
                            <input type="number" name="end_year" id="edit_end_year" class="form-input" min="2021" max="2041" required="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration</label>
                        <select name="duration" id="edit_duration" class="form-input" required="">
                            <option value="daily">Daily</option>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('editEvaluationModal')">Cancel</button>
                <button id="saveEditEvaluationBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save Changes
                </button>
            </div>
        </div>
    </div>

{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.evaluationChartData = {
        statusData: {
            'Pending': {{ response_status_counts.pending|default:0 }},
            'Supervisor Review': {{ response_status_counts.supervisor_review|default:0 }},
            'Manager Review': {{ response_status_counts.manager_review|default:0 }},
            'Approved': {{ response_status_counts.approved|default:0 }},
            'Disapproved': {{ response_status_counts.disapproved|default:0 }}
        },
        evaluationDatasets: [
            {% for evaluation_data in evaluation_datasets %}
            {
                label: '{{ evaluation_data.title }}',
                data: [
                    {% for data_point in evaluation_data.data_points %}
                    {
                        x: '{{ data_point.date|date:"Y-m-d" }}',
                        y: {{ data_point.count }}
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: '{{ evaluation_data.color }}',
                borderColor: '{{ evaluation_data.color }}',
                borderWidth: 2,
                tension: 0.4,
                fill: false
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        totalNonAdminUsers: {{ total_non_admin_users|default:0 }},
        periodData: {
            month: {
                labels: [
                    {% for label in month_labels %}'{{ label }}'{% if not forloop.last %},{% endif %}{% endfor %}
                ],
                datasets: [
                    {% for evaluation_data in month_evaluation_datasets %}
                    {
                        label: '{{ evaluation_data.title }}',
                        data: [
                            {% for count in evaluation_data.monthly_counts %}{{ count }}{% if not forloop.last %},{% endif %}{% endfor %}
                        ],
                        backgroundColor: '{{ evaluation_data.color }}',
                        borderColor: '{{ evaluation_data.color }}',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]
            },
            quarter: {
                labels: [
                    {% for label in quarter_labels %}'{{ label }}'{% if not forloop.last %},{% endif %}{% endfor %}
                ],
                datasets: [
                    {% for evaluation_data in quarter_evaluation_datasets %}
                    {
                        label: '{{ evaluation_data.title }}',
                        data: [
                            {% for count in evaluation_data.quarterly_counts %}{{ count }}{% if not forloop.last %},{% endif %}{% endfor %}
                        ],
                        backgroundColor: '{{ evaluation_data.color }}',
                        borderColor: '{{ evaluation_data.color }}',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]
            },
            year: {
                labels: [
                    {% for label in year_labels %}'{{ label }}'{% if not forloop.last %},{% endif %}{% endfor %}
                ],
                datasets: [
                    {% for evaluation_data in year_evaluation_datasets %}
                    {
                        label: '{{ evaluation_data.title }}',
                        data: [
                            {% for count in evaluation_data.yearly_counts %}{{ count }}{% if not forloop.last %},{% endif %}{% endfor %}
                        ],
                        backgroundColor: '{{ evaluation_data.color }}',
                        borderColor: '{{ evaluation_data.color }}',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]
            }
        }
    };

    // Django Messages Data
    window.djangoMessages = [
        {% for message in messages %}
        {
            message: '{{ message|escapejs }}',
            type: '{{ message.tags|default:"info" }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    {% if created_evaluation_message %}
    // also include session-backed created message to ensure toast after redirect
    window.djangoMessages.push({ message: '{{ created_evaluation_message|escapejs }}', type: 'success' });
    {% endif %}
</script>
<script src="{% static 'js/evaluation/admin_evaluation.js' %}?v={% now "U" %}"></script>
{% endblock extra_js %}
